SUBDIRS=include
CAT=/bin/cat

## src/ output executable will be 'dvda'

## libc_utils is always rebuilt, libFLAC and libfixwav are shipped with package for i386*-*[cygwin linux] distributions
## to avoid conflicts, we take care to add either -l to LDFLAGS links of libs to LDADD, except for static build.
## if giving FLAC or Ogg as input, do also give the other one for compatibility reasons.
## Definitions: WITH_LIB: activates this capability
#               HAVE_EXTERNAL_LIB: use specified lib, e.g. --with-lib=/full/path/to/lib
##              HAVE_LIB: LIB has been tested to be system-installed, so linking should be OK (in principle)


#Interpret: HAVE_X: have X on system
#           HAVE_EXTERNAL_X: given on commandline --with-X=...
#           $(if $(X),...)   or:   ifeq "$(X)" "X": if build package with basename X (--enable-X-build), then do...
#           WITH_X: X-related code was not filtered out by conditional compilation (e.g. WITHOUT-SOX)

.ONESHELL:
SHELL=/bin/sh
SHELLFLAGS=-ec

bin_PROGRAM=dvda-author

CFLAGS += -D_GNU_SOURCE
LDFLAGS=-L/usr/local/lib -L/usr/lib -Xlinker --allow-multiple-definition -L@BUILDDIR@/libs
CPPFLAGS=-I@ROOTDIR@/libutils/src/include -I@ROOTDIR@/src/include -I@ROOTDIR@   ${DEBUG_FLAGS}
LDLIBS= -lm @BUILDDIR@/libutils/src/libc_utils.a

OBJECTS=amg2.o ats.o atsi2.o audio.o auxiliary.o dvda-author.o  \
	     file_input_parsing.o samg2.o launch_manager.o command_line_parsing.o  \
	     lexer.o ats2wav.o

ifneq "@HAVE_core_BUILD@" "yes"
   OBJECTS += menu.o asvs.o xml.o sound.o videoimport.o
endif

ifneq "@WITH_sox@" "no"
    OBJECTS += libsoxconvert.o
endif

ifneq "@MAYBE_fixwav@" ""
     LDLIBS+=$(fixwav_LIB)
     CPPFLAGS +=-I@ROOTDIR@/libfixwav/src/include
endif


$(if $(sox), LIBS   += SOX_LIB_DEPS)

ALL_TARGETS=@PROGRAM_TARGETS@ FLAC libogg sox

.PHONY: program_transform_name create_options all $(ALL_TARGETS)

all:  $(ALL_TARGETS) $(bin_PROGRAM) program_transform_name

$(ALL_TARGETS):
	if test "$($@_LIB)" != ""; then
	      LDLIBS += $($@_LIB)
	      CPPFLAGS += -I@ROOTDIR@/$(MAYBE_$@)/src
		 if test "$(HAVE_EXTERNAL_$@)" = "yes"; then
		    if test "$($@_LIB)" != "yes"; then
		       LDLIBS   += $($@_LIB)
		       echo Linking to system lib $($@_LIB)
		    fi
		 else
		     if test "$(HAVE_$@)" = "yes" ; then
			if test "$($@_LINK)" != ""; then
			  LDFLAGS   += $($@_LINK)
			  echo Linking to user lib $($@_LINK)
			fi
		     else
			echo No linking to $@
		     fi
		 fi
	fi

$(bin_PROGRAM): $(OBJECTS)
program_transform_name: $(bin_PROGRAM)
	mv -f $(bin_PROGRAM) @PACKAGE_NAME@-@VERSION@

# Symbol SOX_LIB_DEPS will be replaced by sox dependencies after configure in libsox by target do_sox_lib_deps_subst
# left-align if conditions

